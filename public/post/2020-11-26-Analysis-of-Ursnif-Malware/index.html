<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title> Reverse Engineering: Malware Analysis of Ursnif | </title>
  
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="all,follow">
  <meta name="googlebot" content="index,follow,snippet,archive">
  <meta property="og:title" content="Reverse Engineering: Malware Analysis of Ursnif" />
<meta property="og:description" content="In this post, I will document my analysis of a malware sample from the Ursnif family. The analysis is only concerned with dissecting the DLL sample, and not the Delivery, and Weaponization procedures.
Ursnif employs quite a few tricks to make the analysis more challenging and hide itself from intruding eyes, such as:
Dynamically importing functions from libraries Storing things encrypted Process Injection Corrupted PE headers Using .rdata to store encrypted payloads encrypted C2 communication Let&rsquo;s get started." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ruysal.com/post/2020-11-26-Analysis-of-Ursnif-Malware/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2020-11-26T19:15:02+00:00" />
<meta property="article:modified_time" content="2020-11-26T19:15:02+00:00" />

  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Reverse Engineering: Malware Analysis of Ursnif"/>
<meta name="twitter:description" content="In this post, I will document my analysis of a malware sample from the Ursnif family. The analysis is only concerned with dissecting the DLL sample, and not the Delivery, and Weaponization procedures.
Ursnif employs quite a few tricks to make the analysis more challenging and hide itself from intruding eyes, such as:
Dynamically importing functions from libraries Storing things encrypted Process Injection Corrupted PE headers Using .rdata to store encrypted payloads encrypted C2 communication Let&rsquo;s get started."/>

  
  
    
  
  
  
  
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  

  
<link rel="icon" type="image/png" href="https://ruysal.com/images/favicon.ico" />

  
  
  
  
</head>

<body class="max-width mx-auto px3 ltr">
  <div class="content index py4">

    <header id="header">
  <a href="https://ruysal.com">
  
    <div id="logo" style="background-image: url(https://ruysal.com/images/skull-ouroboros.jpg)"></div>
  </a>
    <div id="title">
    <h1></h1>
  </div>
  </a>
  <div id="nav">
    <ul>
      <li class="icon">
        <a href="#"><i class="fas fa-bars fa-2x"></i></a>
      </li>
      
        <li><a href="/">Home</a></li>
      
        <li><a href="/about">About</a></li>
      
      <li>
        <div class="js-toggle-wrapper">
    <div class="js-toggle">
        <div class="js-toggle-track">
            <div class="js-toggle-track-check">
                <img src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16">
            </div>
            <div class="js-toggle-track-x">
                <img src="data:image/png;base64,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" role="presentation" style="pointer-events: none;" width="16" height="16">
            </div>
        </div>
        <div class="js-toggle-thumb"></div>
        <input class="js-toggle-screenreader-only" type="checkbox" aria-label="Switch between Dark and Light mode">
    </div>
      </li>
    </ul>
  </div>
    
    

    <style>

 

.js-toggle-wrapper {
    display: table;
    margin: 0 auto;
}

.js-toggle {
    touch-action: pan-x;
    display: inline-block;
    position: relative;
    cursor: pointer;
    background-color: transparent;
    border: 0;
    padding: 0;
    -webkit-touch-callout: none;
    user-select: none;
    -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
    -webkit-tap-highlight-color: transparent;
  }
  
  .js-toggle-screenreader-only {
    border: 0;
    clip: rect(0 0 0 0);
    height: 1px;
    margin: -1px;
    overflow: hidden;
    padding: 0;
    position: absolute;
    width: 1px;
  }
  
  .js-toggle-track {
    width: 50px;
    height: 24px;
    padding: 0;
    border-radius: 30px;
    background-color: hsl(222, 14%, 7%);
    transition: all 0.2s ease;
  }
  
  .js-toggle-track-check {
    position: absolute;
    width: 17px;
    height: 17px;
    left: 5px;
    top: 0px;
    bottom: 0px;
    margin-top: auto;
    margin-bottom: auto;
    line-height: 0;
    opacity: 0;
    transition: opacity 0.25s ease;
  }
  
  .js-toggle--checked .js-toggle-track-check {
    opacity: 1;
    transition: opacity 0.25s ease;
  }
  
  .js-toggle-track-x {
    position: absolute;
    width: 17px;
    height: 17px;
    right: 5px;
    top: 0px;
    bottom: 0px;
    margin-top: auto;
    margin-bottom: auto;
    line-height: 0;
    opacity: 1;
    transition: opacity 0.25s ease;
  }
  
  .js-toggle--checked .js-toggle-track-x {
    opacity: 0;
  }
  
  .js-toggle-thumb {
    position: absolute;
    top: 1px;
    left: 1px;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background-color: #fafafa;
    box-sizing: border-box;
    transition: all 0.5s cubic-bezier(0.23, 1, 0.32, 1) 0ms;
    transform: translateX(0);
  }
  
  .js-toggle--checked .js-toggle-thumb {
    transform: translateX(26px);
    border-color: #19ab27;
  }
  
  .js-toggle--focus .js-toggle-thumb {
  }
  
  .js-toggle:active .js-toggle-thumb {
  }
</style>

<script>
  function loadCSS(mode){
    var headTag = document.getElementsByTagName('head')[0]
    const linkforCSSfile = document.createElement("link");
    linkforCSSfile.href = `/css/style-${mode}.css`
    linkforCSSfile.type = 'text/css'
    linkforCSSfile.rel = 'stylesheet'
    headTag.appendChild(linkforCSSfile);
    document.body.appendChild(headTag);
  }

  var body = document.body;
  var switcher = document.getElementsByClassName('js-toggle')[0];

  
  switcher.addEventListener("click", function() {
        this.classList.toggle('js-toggle--checked');
        this.classList.add('js-toggle--focus');
    
    if (this.classList.contains('js-toggle--checked')) {
      loadCSS("dark");
      
      localStorage.setItem('darkMode', 'true');
    } else {
      loadCSS("light");
      setTimeout(function() {
        localStorage.removeItem('darkMode');
      }, 100);
    }
  })

  
  if (localStorage.getItem('darkMode')) {
    

        switcher.classList.add('js-toggle--checked');
        loadCSS("dark");
  }
  else{
    loadCSS("light");
  }
</script>


  
</header>



    
<article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <div class="content" itemprop="articleBody">
  
    <h2><span><a href="https://ruysal.com/post/2020-11-26-Analysis-of-Ursnif-Malware/">Reverse Engineering: Malware Analysis of Ursnif</a></span></h2>
    
        <nav id="TableOfContents">
  <ul>
    <li><a href="#static-analysis">Static Analysis</a></li>
    <li><a href="#first-execution">First Execution</a></li>
    <li><a href="#1st-stage---mailslots">1st Stage - Mailslots</a></li>
    <li><a href="#2nd-stage">2nd Stage</a></li>
    <li><a href="#process-injection">Process Injection</a></li>
    <li><a href="#explorerexe">explorer.exe</a></li>
    <li><a href="#ioc">IOC</a></li>
    <li><a href="#references-and-further-reading">References and Further Reading</a></li>
  </ul>
</nav>
    
    <p>In this post, I will document my analysis of a malware sample from the Ursnif family. The analysis is only concerned with dissecting the DLL sample, and not the <code>Delivery</code>, and <code>Weaponization</code> procedures.</p>
<p>Ursnif employs quite a few tricks to make the analysis more challenging and hide itself from intruding eyes, such as:</p>
<ul>
<li>Dynamically importing functions from libraries</li>
<li>Storing things encrypted</li>
<li>Process Injection</li>
<li>Corrupted PE headers</li>
<li>Using .rdata to store encrypted payloads</li>
<li>encrypted C2 communication</li>
</ul>
<p>Let&rsquo;s get started.</p>
<h2 id="static-analysis">Static Analysis</h2>
<p>Static analysis is the first step to get an idea of what we are up against. One of the first tools I use for this is <code>PEStudio</code>.</p>
<!-- raw HTML omitted -->
<p><img src="/assets/img/ursnif/2-pestudio-sections.png" alt="Sections"></p>
<p>There are a few things we can infer from this:</p>
<ul>
<li>It is a DLL file, and has no exported functions</li>
<li>There are not many imported functions to reveal its functionality</li>
<li>.rdata is bigger than .text section and it takes up almost half of the file&rsquo;s total size.</li>
</ul>
<p>Next, let&rsquo;s check some of the strings to see if we can find anything useful:</p>
<p><img src="/assets/img/ursnif/4-strings.png" alt="Strings"></p>
<p>The pdb string looks unique to be an identifier for our sample. I&rsquo;ve included it <a href="#identifiers">at the bottom of the post</a> for further identification/detection purposes.</p>
<h2 id="first-execution">First Execution</h2>
<p>Ursnif unpacks itself and delivers its payload in multiple stages. So, it would be easier to let it run once, observe its behavior with <code>Procmon</code> to get an overview of what it is doing, and try to follow the steps with the debugger next. The DLL can be executed with one of the following commands:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>rundll32 ursnif.dll, DllRegisterServer
</span></span><span style="display:flex;"><span>regsvr32.exe ursnif.dll
</span></span></code></pre></div><p>Now, let&rsquo;s examine the output from procmon.
<img src="/assets/img/ursnif/5-procmon.png" alt="procmon"></p>
<p>First, it seems like ursnif creates 2 threads. After those threads exit, a 3rd one is created. Within the 3rd thread, ursnif&rsquo;s first stage payload is executed. A bit down below, this payload is analyzed in more detail.</p>
<p>One of the interesting things I noticed was that this payload is 296KB, whereas the DLL file itself (from which we started execution) is 790KB.
This means that the first 2 threads do some sort of unpacking, and a 3rd thread is created with the unpacked executable.</p>
<h2 id="1st-stage---mailslots">1st Stage - Mailslots</h2>
<p>Let&rsquo;s start the analysis of the first 2 threads that we&rsquo;ve seen on Procmon.</p>
<p>I will use x32dbg to analyze this sample. Make sure that you are breaking on <code>Thread Entry</code>, which can be checked under your debugger&rsquo;s preferences.
Below you can see the entry of the first thread. Ursnif first obtains the current process id, which on my system is <code>0xFFC</code>. It uses this PID to generate a name for the mailslot. On my environment, the mailslot&rsquo;s name is: <code>\\\\.\\mailslot\\slffc</code>
<img src="/assets/img/ursnif/00-first.png" alt="firstthread"></p>
<p>If like me, your first question was &ldquo;wtf is a mailslot?&rdquo;, it is, quoting from <a href="https://en.wikipedia.org/wiki/MailSlot">Wikipedia</a>:</p>
<blockquote>
<p>a one-way interprocess communication mechanism, available on the Microsoft Windows operating system, that allows communication between processes both locally and over a network.</p>
</blockquote>
<p><img src="/assets/img/ursnif/01-2ndthread.png" alt="secondthread">
Ursnif utilizes mailslots to pass an executable between the two threads it creates. In the first thread, it calls <code>CreateMailSlot</code>, and then <code>ReadFile</code> with the handle of the previously created mailslot. If the call fails, it calls <code>Sleep</code> and tries again later.</p>
<p>At the second thread, it calls <code>CreateFile</code> with the handle of previously created mailslot. If <code>CreateFile</code> fails, ursnif calls <code>Sleep</code> and tries again in a while. The screenshot above is from the 2nd thread.</p>
<p>In the screenshot below, you can see a PE file with an erased header that ursnif writes. This will be inspected in detail at 2nd stage.</p>
<p>Ursnif then calls <code>WriteFile</code> to copy the PE file in the memory to the mailslot. It writes <code>0x1000</code> bytes at a time. After the call, it sleeps for <code>64ms</code> and then the routine above is repeated, until all of the file is written to the mailslot.
<img src="/assets/img/ursnif/02-pe.png" alt="secondthread"></p>
<p>The other thread calls <code>ReadFile</code> to retrieve the PE file and places it in the <code>heap</code>. After the routine finishes, the first 2 threads are killed and execution continues from the 3rd thread.</p>
<h2 id="2nd-stage">2nd Stage</h2>
<p>After the first 2 threads are finished executing, the execution is handed over to the 3rd thread and we land on this piece of code:
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002245</span><span style="color:#a6e22e">E</span> <span style="color:#f92672">|</span> FF7424 <span style="color:#ae81ff">04</span>   <span style="color:#f92672">|</span> push <span style="color:#66d9ef">dword</span> ptr ss:[esp<span style="color:#f92672">+</span><span style="color:#ae81ff">4</span>]                    <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002245</span><span style="color:#a6e22e">E</span> <span style="color:#f92672">|</span> E8 F1F7FFFF <span style="color:#f92672">|</span> call <span style="color:#ae81ff">223</span>DE2                                  <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002245</span><span style="color:#a6e22e">F</span> <span style="color:#f92672">|</span> B9 E4752200 <span style="color:#f92672">|</span> mov ecx,<span style="color:#ae81ff">2275</span>E4                               <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002245</span><span style="color:#a6e22e">F</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">83</span>CA FF     <span style="color:#f92672">|</span> or edx,FFFFFFFF                              <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002245</span><span style="color:#a6e22e">F</span> <span style="color:#f92672">|</span> F0:<span style="color:#ae81ff">0</span>FC111   <span style="color:#f92672">|</span> lock xadd <span style="color:#66d9ef">dword</span> ptr ds:[ecx],edx             <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002245</span><span style="color:#a6e22e">F</span> <span style="color:#f92672">|</span> C2 <span style="color:#ae81ff">0400</span>     <span style="color:#f92672">|</span> ret <span style="color:#ae81ff">4</span>                                        <span style="color:#f92672">|</span></span></span></code></pre></div>
So everything we are looking for happens in this call. Since the first stage is unpacked, I wanted to check the Referenced Calls to see what the actual imported functions are:</p>
<p><img src="/assets/img/ursnif/6-firstthreadcalls.png" alt="referencedcalls"></p>
<p>The calls we see here are quite different than the ones we see at static analysis of 1st stage. The ones below are especially worth of note, as they are commonly used for <code>Process Injection</code>. There are also some calls to file and registry read/write APIs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">ntdll.ZwCreateSection</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">ntdll.ZwMapViewOfSection</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">ntdll.ZwUnmapViewOfSection</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">kernel32.VirtualProtect</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">kernel32.VirtualAlloc</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">kernel32.SuspendThread</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">advapi32.RegSetValueExA</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>While analyzing ursnif, you will constantly run into calls related to <code>heap</code>. I&rsquo;ve seen some other posts detailing the way ursnif makes use of the heap, so I will skip that. Debuggers don&rsquo;t do justice to keeping track of the heap, so this makes analysis a bit more challenging. The relevant calls can be seen in the list of referenced calls:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">kernel32.HeapCreate</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">kernel32.HeapFree</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">&lt;</span><span style="color:#a6e22e">ntdll.RtlAllocateHeap</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>At this point, I wanted to check where we are executing from, and whether we could dump the executed module. The dumped file is 296kb, whereas the original sample was 790kb. As can be seen below, ursnif corrupts the PE headers (the one that was written mentioned earlier), which makes it evade automated dumping.</p>
<p><img src="/assets/img/ursnif/8-pe-firststage.png" alt="peheader"></p>
<p>Upon execution, one of the first things ursnif does is checking the file <code>C_1252NLS</code> under <code>System32</code>. The reason for this is stated in the leaked <code>Gozi/ISFB</code> loader as:</p>
<blockquote>
<p>Opening c_1252.nls file and getting it&rsquo;s write time.</p>
<p>Thus we can determine a time when OS was installed.</p>
<p>Source: <a href="https://github.com/gbrindisi/malware/blob/master/windows/gozi-isfb/install.c#L112">windows/gozi-isfb/install.c#L112</a></p>
</blockquote>
<p><img src="/assets/img/ursnif/7-c1252.png" alt="c1252"></p>
<p>Although ursnif is based on the leaked source code, it is modified and constantly updated. However, this behavior seems to have been persisting, so it can be used as a <a href="#identifiers">unique identifier</a>.</p>
<p>After this, within the same function call, Ursnif &ldquo;generates module names&rdquo;. By this I mean the name of the DLL file to be dropped, and the name of the autorun key to execute that DLL file. This routine as well is present in the leaked Gozi-ISFB source code. You can check out the relevant source code by the following links:</p>
<blockquote>
<p><a href="https://github.com/gbrindisi/malware/blob/667b44f64edcd1c5e8c42489b8e767813a589158/windows/gozi-isfb/install.c#L87">GenModuleName: windows/gozi-isfb/install.c#L87</a></p>
<p><a href="https://github.com/gbrindisi/malware/blob/667b44f64edcd1c5e8c42489b8e767813a589158/windows/gozi-isfb/install.c#L228">SetAutoRun: windows/gozi-isfb/install.c#L228</a></p>
</blockquote>
<p>This is added to the list of <a href="#identifiers">unique identifiers</a> as well.</p>
<p>At the end of this routine, on my system the generated names for the dll and folder are:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002241</span><span style="color:#a6e22e">F</span> <span style="color:#f92672">|</span> BF D0762200 <span style="color:#f92672">|</span> mov edi,<span style="color:#ae81ff">2276</span>D0                           <span style="color:#f92672">|</span> <span style="color:#ae81ff">2276</span>D0:<span style="color:#f92672">&amp;</span>L<span style="color:#e6db74">&#34;blb_OMEX&#34;</span><span style="color:#75715e">;this is the key name for autorun</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00222</span><span style="color:#a6e22e">F1</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">8</span>B45 <span style="color:#ae81ff">08</span>     <span style="color:#f92672">|</span> mov eax,<span style="color:#66d9ef">dword</span> ptr ss:[ebp<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]             <span style="color:#f92672">|</span> [ebp<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]:<span style="color:#f92672">&amp;</span><span style="color:#e6db74">&#34;ddraWNet&#34;</span><span style="color:#75715e">;folder name to be created under %appdata%\Microsoft\</span>
</span></span></code></pre></div><p>After this, the following key is acquired. This is important, as ursnif drops some important keys under here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00223</span><span style="color:#a6e22e">BD</span> <span style="color:#f92672">|</span> A3 DC762200 <span style="color:#f92672">|</span> mov <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#ae81ff">2276</span>DC],eax            <span style="color:#f92672">|</span> eax:<span style="color:#e6db74">&#34;Software\\AppDataLow\\Software\\Microsoft\\FD56FF74-382C-3782-2A81-EC5BFE45E0BF&#34;</span>
</span></span></code></pre></div><p>And the name of the DLL file to be dropped under %appdata% is copied:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">00223</span><span style="color:#a6e22e">F1</span> <span style="color:#f92672">|</span> FF35 D47622 <span style="color:#f92672">|</span> push <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#ae81ff">2276</span>D4]               <span style="color:#f92672">|</span> <span style="color:#ae81ff">002276</span>D4:<span style="color:#f92672">&amp;</span>L<span style="color:#e6db74">&#34;bcdpbres.dll&#34;</span>
</span></span></code></pre></div><p>To spare some details, I will accompany some of the important calls with procmon logs. That way we can just look at the end results and where the calls have originated from.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C508</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">34602</span>C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>RegOpenKeyExA<span style="color:#f92672">&gt;</span>]     <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Procmon</span> Log: <span style="color:#ae81ff">5</span>:<span style="color:#ae81ff">39</span>:<span style="color:#ae81ff">47.2296762</span> AM	rundll32.exe	<span style="color:#ae81ff">2800</span>	RegOpenKey	HKU	SUCCESS	Desired Access: Maximum Allowed, Granted Access: All Access
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C50D</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">08602</span>C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>RegEnumKeyExA<span style="color:#f92672">&gt;</span>]     <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C512</span> <span style="color:#f92672">|</span> E8 <span style="color:#ae81ff">69</span>D4FFFF <span style="color:#f92672">|</span> call <span style="color:#ae81ff">2</span>C2599                              <span style="color:#f92672">|</span><span style="color:#75715e">;we have to dive into one more call</span>
</span></span></code></pre></div><p>After here, we dive into the call and follow the steps from there:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C266</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">8</span>B35 <span style="color:#ae81ff">38602</span>C <span style="color:#f92672">|</span> mov esi,<span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>RegQueryValueExW <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C267</span> <span style="color:#f92672">|</span> FFD6        <span style="color:#f92672">|</span> call esi                                 <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Procmon</span> Logs:
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">5:46:50</span><span style="color:#a6e22e">.8931454</span> AM	rundll32.exe	<span style="color:#ae81ff">2800</span>	RegQueryValue	HKCU<span style="color:#960050;background-color:#1e0010">\</span>Software<span style="color:#960050;background-color:#1e0010">\</span>Microsoft<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>CurrentVersion<span style="color:#960050;background-color:#1e0010">\</span>Explorer<span style="color:#960050;background-color:#1e0010">\</span>Shell Folders<span style="color:#960050;background-color:#1e0010">\</span>AppData	SUCCESS	Type: REG_SZ, Length: <span style="color:#ae81ff">64</span>, Data: C:<span style="color:#960050;background-color:#1e0010">\</span>Users<span style="color:#960050;background-color:#1e0010">\</span>IEUser<span style="color:#960050;background-color:#1e0010">\</span>AppData<span style="color:#960050;background-color:#1e0010">\</span>Roaming
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">5:59:07</span><span style="color:#a6e22e">.4587868</span> AM	rundll32.exe	<span style="color:#ae81ff">2800</span>	RegQueryValue	HKU<span style="color:#960050;background-color:#1e0010">\</span>S<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span><span style="color:#f92672">-</span><span style="color:#ae81ff">21</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3583694148</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1414552638</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2922671848</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1002</span><span style="color:#960050;background-color:#1e0010">\</span>Software<span style="color:#960050;background-color:#1e0010">\</span>Microsoft<span style="color:#960050;background-color:#1e0010">\</span>Windows<span style="color:#960050;background-color:#1e0010">\</span>CurrentVersion<span style="color:#960050;background-color:#1e0010">\</span>Explorer<span style="color:#960050;background-color:#1e0010">\</span>Shell Folders<span style="color:#960050;background-color:#1e0010">\</span>AppData	NAME NOT FOUND	Length: <span style="color:#ae81ff">144</span>
</span></span></code></pre></div><p>This is done to acquire the <code>%appdata%</code> path for each user account to be infected. A call to <code>PathCombineW</code> is made to append <code>\Microsoft</code> to absolute path of appdata. The previously generated system specific directory (in my case <code>ddraWNet</code>) is created at this location.</p>
<p>Here, ursnif checks whether it is being executed from the dropped location under appdata. If it does, it skips the rest of the function because this would mean the payload has already been executed once, and there is no need to drop itself again.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C271</span> <span style="color:#f92672">|</span> FF35 <span style="color:#ae81ff">08762</span>C <span style="color:#f92672">|</span> push <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#ae81ff">2</span>C7608]                 <span style="color:#f92672">|</span> <span style="color:#ae81ff">002</span>C7608:<span style="color:#f92672">&amp;</span>L<span style="color:#e6db74">&#34;C:\\Users\\IEUser\\Desktop\\sample\\75a86f64c1ab7d8a56532b793a8547b7.dll&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C271</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">57</span>          <span style="color:#f92672">|</span> push edi                                   <span style="color:#f92672">|</span> edi:L<span style="color:#e6db74">&#34;C:\\Users\\IEUser\\AppData\\Roaming\\Microsoft\\DdraWNet\\bcdpbres.dll&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C271</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">6</span>C602C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>lstrcmpiW<span style="color:#f92672">&gt;</span>]           <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C272</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">85</span>C0        <span style="color:#f92672">|</span> test eax,eax                               <span style="color:#f92672">|</span> eax:L<span style="color:#e6db74">&#34;C:\\Users\\IEUser\\AppData\\Roaming\\Microsoft\\DdraWNet\\bcdpbres.dll&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C272</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">0</span>F84 D80100 <span style="color:#f92672">|</span> je <span style="color:#ae81ff">2</span>C2902                                  <span style="color:#f92672">|</span>
</span></span></code></pre></div><p>Since this is our first run, we don&rsquo;t take the jump and continue to this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C486</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">8</span>B35 <span style="color:#ae81ff">34612</span>C <span style="color:#f92672">|</span> mov esi,<span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>WriteFile<span style="color:#f92672">&gt;</span>]        <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C48A</span> <span style="color:#f92672">|</span> FFD6        <span style="color:#f92672">|</span> call esi                                   <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C48B</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">2</span>C612C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>SetEndOfFile<span style="color:#f92672">&gt;</span>]        <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C490</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">38612</span>C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>FlushFileBuffers<span style="color:#f92672">&gt;</span>]    <span style="color:#f92672">|</span>
</span></span></code></pre></div><p>Now the sample has dropped itself on disk. The dropped one is the same as the one we started the execution from(790KB). Since <code>DdraWNet\\bcdpbres.dll</code> will be added to startup under <code>Run</code> key, and it is the main loader, this means in each startup, it will unpack itself, inject itself to another process, and continue execution from there.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C27B</span> <span style="color:#f92672">|</span> FF75 <span style="color:#ae81ff">1</span>C     <span style="color:#f92672">|</span> push <span style="color:#66d9ef">dword</span> ptr ss:[ebp<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>C]                 <span style="color:#f92672">|</span> [ebp<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>C]:L<span style="color:#e6db74">&#34;rundll32 \&#34;C:\\Users\\IEUser\\AppData\\Roaming\\Microsoft\\DdraWNet\\bcdpbres.dll\&#34;,DllRegisterServer&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C27C</span> <span style="color:#f92672">|</span> FF15 BC602C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>lstrcpy<span style="color:#f92672">&gt;</span>]             <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C27D</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">50</span>          <span style="color:#f92672">|</span> push eax                                   <span style="color:#f92672">|</span> eax:<span style="color:#e6db74">&#34;Software\\AppDataLow\\Software\\Microsoft\\FD56FF74-382C-3782-2A81-EC5BFE45E0BF&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C27D</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">20602</span>C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>RegCreateKeyA<span style="color:#f92672">&gt;</span>]       <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C280</span> <span style="color:#f92672">|</span> FF15 <span style="color:#ae81ff">1</span>C602C <span style="color:#f92672">|</span> call <span style="color:#66d9ef">dword</span> ptr ds:[<span style="color:#f92672">&lt;&amp;</span>RegQueryValueExA<span style="color:#f92672">&gt;</span>]    <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">6:52:26</span><span style="color:#a6e22e">.0547460</span> AM	rundll32.exe	<span style="color:#ae81ff">2800</span>	RegSetValue	HKCU<span style="color:#960050;background-color:#1e0010">\</span>Software<span style="color:#960050;background-color:#1e0010">\</span>AppDataLow<span style="color:#960050;background-color:#1e0010">\</span>Software<span style="color:#960050;background-color:#1e0010">\</span>Microsoft<span style="color:#960050;background-color:#1e0010">\</span>FD56FF74<span style="color:#f92672">-</span><span style="color:#ae81ff">382</span>C<span style="color:#f92672">-</span><span style="color:#ae81ff">3782</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>A81<span style="color:#f92672">-</span>EC5BFE45E0BF<span style="color:#960050;background-color:#1e0010">\</span>Client32	SUCCESS	Type: REG_BINARY, Length: <span style="color:#ae81ff">204</span>,<span style="color:#ae81ff">288</span>, Data: <span style="color:#ae81ff">96</span> F8 <span style="color:#ae81ff">2</span>A <span style="color:#ae81ff">18</span> <span style="color:#ae81ff">2</span>F F1 C5 <span style="color:#ae81ff">2</span>F C9 E9 <span style="color:#ae81ff">60</span> <span style="color:#ae81ff">47</span> <span style="color:#ae81ff">5</span>E E2 FC <span style="color:#ae81ff">5</span>E
</span></span></code></pre></div><p>Here ursnif sets a few keys under AppDataLow for persistency.</p>
<p>After this, every string that was stored in the heap is released. These include the names of the registry keys, appdata, dropped DLL&rsquo;s name etc. Like mentioned before, ursnif tries to retrieve things dynamically as much as possible. At the end of the routine, it releases the heap memory. This leaves us with a very narrow window to peek into the strings.</p>
<p>After it copies itself under <code>%appdata%</code> and drops the keys at <code>appdatalow</code> key, ursnif attempts to <code>delete</code> itself. If it fails, it calls <code>MoveFileExW</code> with the argument <code>0x4</code>, which according to Microsoft&rsquo;s documentation corresponds to <code>MOVEFILE_DELAY_UNTIL_REBOOT</code>. Quoting from the documentation:</p>
<blockquote>
<p>The system does not move the file until the operating system is restarted. The system moves the file immediately after AUTOCHK is executed, but before creating any paging files.</p>
</blockquote>
<p><img src="/assets/img/ursnif/9-delete.png" alt="Delete"></p>
<p>Since this is the file we are currently executing from, <code>DeleteFileW</code> will fail and it will do this operation after the reboot.</p>
<h2 id="process-injection">Process Injection</h2>
<p>Ursnif then calls a function to perform process injection.</p>
<p>Inside this function, a call is made to the <code>RtlGetNativeSystemInformation</code> API. Among other things, this is used to retrieve a list of running processes on the system.</p>
<p><img src="/assets/img/ursnif/10-nativesysteminformation.png" alt="Nativesystem">
<code>esi</code> holds the address to the struct to be filled, which can be seen in the dump. Inside <code>381A3D</code>, a call is made to <code>002C346A</code>, which contains the process injection routine. This function takes the struct shown above as an argument.</p>
<p><img src="/assets/img/ursnif/11-hashProcess.png" alt="hashprocess">
The above checks one of the struct members got from the undocumented call and if it is 0, it jumps to the end of the routine. ursnif uses this struct to retrieve a list of the running processes. It then enumerates these processes one by one, calculates the <code>checksum</code> of each process&rsquo; name, and compares them against the precalculated ones:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34B</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>D <span style="color:#ae81ff">121725</span>AC <span style="color:#f92672">|</span> cmp eax,AC251712                  <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34B</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">47</span>       <span style="color:#f92672">|</span> je <span style="color:#ae81ff">2</span>C3504                         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34B</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>D <span style="color:#ae81ff">8</span>A8EFE58 <span style="color:#f92672">|</span> cmp eax,<span style="color:#ae81ff">58</span>FE8E8A                  <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34C</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">40</span>       <span style="color:#f92672">|</span> je <span style="color:#ae81ff">2</span>C3504                         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34C</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>D <span style="color:#ae81ff">65496</span>DA7 <span style="color:#f92672">|</span> cmp eax,A76D4965                  <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34C</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">39</span>       <span style="color:#f92672">|</span> je <span style="color:#ae81ff">2</span>C3504                         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34C</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>D <span style="color:#ae81ff">12</span>D72C96 <span style="color:#f92672">|</span> cmp eax,<span style="color:#ae81ff">962</span>CD712                  <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34D</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">74</span> <span style="color:#ae81ff">32</span>       <span style="color:#f92672">|</span> je <span style="color:#ae81ff">2</span>C3504                         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34D</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">3</span>D F5BBE0A6 <span style="color:#f92672">|</span> cmp eax,A6E0BBF5                  <span style="color:#f92672">|</span><span style="color:#75715e">;explorer.exe</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">002</span><span style="color:#a6e22e">C34D</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">75</span> <span style="color:#ae81ff">36</span>       <span style="color:#f92672">|</span> jne <span style="color:#ae81ff">2</span>C350F                        <span style="color:#f92672">|</span>
</span></span></code></pre></div><p>After looping through the process list, ursnif finally reaches <code>explorer.exe</code>, whose value corresponds to <code>A6E0BBF5</code>. I did not confirm this, but based on what I&rsquo;ve seen on other reports for this family, one of the other values might be for <code>svchost.exe</code>.</p>
<p>The jump takes us to another function call, which lets ursnif inject itself into <code>explorer.exe</code>. I was curious where the other jumps above would lead us to, and one of them seems to create a process. My guess is that if it does not find a suitable process to be injected, it creates one for itself.
<img src="/assets/img/ursnif/12-process-create.png" alt="hashprocess"></p>
<p>Continuing, ursnif calls <code>OpenProcess</code> to acquire a handle to <code>explorer.exe</code>. Then it makes a call to <code>GetProcAddress</code> with the handle of <code>explorer.exe</code> to get the address of <code>ntdll.RtlExitUserThread</code>.</p>
<p>Next, it calls <code>GetProcAddress</code> again. This time to get the address of <code>CreateRemoteThread</code>. And then, it calls <code>CreateRemoteThread</code>, with the <code>LPTHREAD_START_ROUTINE lpStartAddress</code> of <code>ntdll.RtlExitUserThread</code>. So, the injected thread will start executing from <code>RtlExitUserThread</code>. The thread is also created in <code>suspended</code> state.</p>
<p><img src="/assets/img/ursnif/13-createthread.png" alt="createthread"></p>
<p>After the thread is created, ursnif calls <code>ZwReadVirtualMemory</code> to read the first 4 bytes from the created thread&rsquo;s <code>EIP</code>. These 4 bytes are saved in a buffer. Ursnif then calls <code>VirtualProtectEx</code> to make the <code>page</code> from <code>RtlExitUserThread</code> writable. It uses <code>ZwWriteVirtualMemory</code> to write the bytes <code>EB FE CC CC</code> to the buffer, and resumes the thread.</p>
<p><code>EB FE</code> is quite a famous piece of opcode. It is an <code>infinite loop</code>, achieved by a relative short jump. Since short jumps takes 2 bytes, by jumping back 2 bytes, an infinite loop can be created. After the infinite loop, the next two bytes are <code>CC CC</code>, which are used for software breakpoints (more specifically, <code>debug exception handler</code>).</p>
<p>To sum up:</p>
<ol>
<li>Ursnif acquires a handle to <code>explorer.exe</code></li>
<li>From <code>explorer.exe</code>, gets address of <code>ntdll.RtlExitUserThread</code></li>
<li>Creates a suspended thread with EP set to <code>ntdll.RtlExitUserThread</code></li>
<li>Reads the first 4 bytes from the thread</li>
<li>Replaces the first 4 bytes from EP with <code>EBFECCCC</code>, which creates an infinite loop</li>
</ol>
<p>After seeing the disassembly for this function, I&rsquo;ve checked some of the material published on this malware family. In the blog referred below, the behavior listed above is described in pseudo-code.</p>
<blockquote>
<p><a href="https://arielkoren.com/blog/2016/11/01/ursnif-malware-deep-technical-dive/">https://arielkoren.com/blog/2016/11/01/ursnif-malware-deep-technical-dive/</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-csharp" data-lang="csharp"><span style="display:flex;"><span><span style="color:#75715e">/* source link above, copied from arielkoren.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">/* Obtain the process pid to inject to */</span>
</span></span><span style="display:flex;"><span>dwPID = GetInjectProcess()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>hProcess = OpenProcess(dwPID, ...)
</span></span><span style="display:flex;"><span>pAddress = GetProcAddress(<span style="color:#e6db74">&#34;ntdll.dll&#34;</span>, <span style="color:#e6db74">&#34;RtlExitUserThread&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Create remote thread in suspended mode */</span>
</span></span><span style="display:flex;"><span>hThread = CreateRemoteThread(hProcess, 			<span style="color:#75715e">/* Remote process handle */</span>
</span></span><span style="display:flex;"><span>                            CREATE_SUSPENDED,	<span style="color:#75715e">/* creation flags */</span>
</span></span><span style="display:flex;"><span>                            pAddress,			<span style="color:#75715e">/* thread function address */</span>
</span></span><span style="display:flex;"><span>                            ...)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Read remote procedure first four bytes */</span>
</span></span><span style="display:flex;"><span>dwBackupData = ZwReadVirtualMemory(hProcess,	<span style="color:#75715e">/* Remote process handle */</span>
</span></span><span style="display:flex;"><span>								pAddress,		<span style="color:#75715e">/* Address to read */</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#ae81ff">4</span>,				<span style="color:#75715e">/* number of bytes to read */</span>
</span></span><span style="display:flex;"><span>                                ...)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">/* Change address protection to `writable` */</span>
</span></span><span style="display:flex;"><span>VirtualProtectEx(hProcess,			<span style="color:#75715e">/* Remote process handle */</span>
</span></span><span style="display:flex;"><span>				READ_WRITE_EXECUTE,	<span style="color:#75715e">/* New protection flags */</span>
</span></span><span style="display:flex;"><span>				pAddress,			<span style="color:#75715e">/* Address to change protection on */</span>
</span></span><span style="display:flex;"><span>				<span style="color:#ae81ff">4</span>,					<span style="color:#75715e">/* Size of address */</span>
</span></span><span style="display:flex;"><span>				...)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ZwWriteVirtualMemory(hProcess,	<span style="color:#75715e">/* Remote process handle */</span>
</span></span><span style="display:flex;"><span>					pAddress,	<span style="color:#75715e">/* Address to overwrite */</span>
</span></span><span style="display:flex;"><span>					<span style="color:#ae81ff">0xCCCCFEEB</span>,	<span style="color:#75715e">/* Data to write */</span>
</span></span><span style="display:flex;"><span>					<span style="color:#ae81ff">4</span>,			<span style="color:#75715e">/* Size of data */</span>
</span></span><span style="display:flex;"><span>					...)
</span></span></code></pre></div><p>During my first analysis of ursnif, I noticed that a couple of seconds into the execution, CPU usage spiked to quite a high level, and the environment became almost unresponsive for a moment.</p>
<p>Looking at the screenshot below, I realized why. Since ursnif writes infinite loop at the entry point of <code>RtlExitUserThread</code>, whenever a user thread exited during this stage, it started running the infinite loop. This caused several threads to be in an infinite loop, draining a lof of CPU time. You can see that at least 4 threads have their EIP pointed at the infinite loop. However, only one of the threads&rsquo; EP points to the infinite loop, and it is suspended.</p>
<p><img src="/assets/img/ursnif/14-newthread.png" alt="newthread"></p>
<p>After this, ursnif resumes the thread for a short period for initialization, and suspends again. It calls <code>NtGetContextThread</code>, and uses the returned <code>struct</code> to modify the entry point of the thread. During the following routine, it calls</p>
<ul>
<li><code>ZwCreateSection</code></li>
<li><code>ZwMapViewOfSection</code></li>
<li><code>GetModuleHandleA</code></li>
<li><code>GetModuleFileNameW</code></li>
</ul>
<p>And then it uses these to retrieve addresses of <code>LdrLoadDll</code>, <code>LdrGetProcedureAddress</code>, and <code>ZwProtectVirtualMemory</code>. Ursnif then calls <code>ZwAllocateVirtualMemory</code> to allocate memory in explorer.exe&rsquo;s address space. In the screenshot below, the allocated address is <code>01FD0000</code>, and allocated space is <code>0x1000</code> bytes big.</p>
<p><img src="/assets/img/ursnif/15-explorer-allocate.png" alt="explorersection"></p>
<p>Ursnif then copies the payload to explorer&rsquo;s address space. In the screenshot below, the payload can be seen in dump:
<img src="/assets/img/ursnif/16-payload-to-copy.png" alt="payloadtocopy"></p>
<p>The disassembly of the payload looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-nasm" data-lang="nasm"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">01</span><span style="color:#a6e22e">A193E</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">8</span>B48 <span style="color:#ae81ff">08</span>     <span style="color:#f92672">|</span> mov ecx,<span style="color:#66d9ef">dword</span> ptr ds:[eax<span style="color:#f92672">+</span><span style="color:#ae81ff">8</span>]       <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">01</span><span style="color:#a6e22e">A193E</span> <span style="color:#f92672">|</span> FF70 <span style="color:#ae81ff">10</span>     <span style="color:#f92672">|</span> push <span style="color:#66d9ef">dword</span> ptr ds:[eax<span style="color:#f92672">+</span><span style="color:#ae81ff">10</span>]         <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">01</span><span style="color:#a6e22e">A193E</span> <span style="color:#f92672">|</span> FF30        <span style="color:#f92672">|</span> push <span style="color:#66d9ef">dword</span> ptr ds:[eax]            <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">01</span><span style="color:#a6e22e">A193E</span> <span style="color:#f92672">|</span> <span style="color:#ae81ff">51</span>          <span style="color:#f92672">|</span> push ecx                           <span style="color:#f92672">|</span>
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">01</span><span style="color:#a6e22e">A193E</span> <span style="color:#f92672">|</span> C3          <span style="color:#f92672">|</span> ret                                <span style="color:#f92672">|</span>
</span></span></code></pre></div><p>Since there is a <code>ret to push</code>, we will have to wait until the thread is executed to see where we will jump.</p>
<p>Ursnif then calls <code>ZwUnmapViewofSection</code> on a region with the size of <code>0x68000</code>. The section contains a 416KB PE file with erased header.</p>
<p>Continuing, ursnif calls <code>ZwWriteVirtualMemory</code> with the address of previously allocated space in explorer.exe, <code>01FD0000</code>, and the payload shown above.</p>
<p>Then ursnif calls <code>ZwSetContextThread</code>, with the new <code>EIP</code> written into the context. In the screenshot below, new <code>EIP</code> can be seen as <code>01FD0218</code>. Now we can attach to explorer.exe, set our breakpoint there, and let explorer.exe continue its execution.
<img src="/assets/img/ursnif/17-context.png" alt="newcontext"></p>
<p>Ursnif calls <code>ZwWriteVirtualMemory</code> again, this time to restore the previously overwritten 4 bytes; <code>EB FE CC CC</code>. It then calls <code>VirtualProtectEx</code> to restore the <code>page</code> rights. After this, process injection routine is finished, and ursnif calls <code>ResumeThread</code>.</p>
<h2 id="explorerexe">explorer.exe</h2>
<p>Immediately, our breakpoint at <code>01A193E</code> is triggered. The <code>push ecx, ret</code> routine takes the execution to another memory region, with the size <code>0x68000</code> (416KB). This is the PE file with erased header, previously used with <code>ZwUnmapViewOfSection</code>.</p>
<p>At this point, the analysis has become another side project that&rsquo;s waiting to see the light of day again. So that&rsquo;s it for this post. Who knows, maybe I can publish part 2 of this one day.</p>
<h2 id="ioc">IOC</h2>
<pre tabindex="0"><code>MD5: 75a86f64c1ab7d8a56532b793a8547b7
SHA256: 0f06bc2f24494d9206d8d985f0a2f13ec6975a225c0bdcbab6d7f74474ff70a6

File Access: c:\windows\system32\c_1252.nls
PDB String: c:\\path\\Know\\School\\Rest\\sing\\Pick\\officerun.pdb
File Write: %appdata%/Roaming/-RandomName-/-RandomName-.dll
Registry Write: HKCU\Software\Microsoft\Windows\CurrentVersion\Run
Registry Write: HKCU\Software\AppDataLow\Software\Microsoft\{GUID}
File Write: %temp%/[A-Fa-f0-9]{4}.bin
Network Data Format(Before Encryption): soft=%u&amp;version=%u&amp;user=%08x%08x%08x%08x&amp;server=%u&amp;id=%u&amp;crc=%x
Network Data Format(After Encryption): images/[encryted_data]/.[extension]
</code></pre><h2 id="references-and-further-reading">References and Further Reading</h2>
<p><a href="https://forums.juniper.net/t5/Threat-Research/The-Gozi-Sleeper-Cell/ba-p/329691">https://forums.juniper.net/t5/Threat-Research/The-Gozi-Sleeper-Cell/ba-p/329691</a></p>
<p><a href="https://www.vmray.com/cyber-security-blog/analyzing-ursnif-behavior-malware-sandbox/">https://www.vmray.com/cyber-security-blog/analyzing-ursnif-behavior-malware-sandbox/</a></p>
<p><a href="https://arielkoren.com/blog/2016/11/01/ursnif-malware-deep-technical-dive/">https://arielkoren.com/blog/2016/11/01/ursnif-malware-deep-technical-dive/</a></p>
<p><a href="https://www.netskope.com/blog/ursnif-data-theft-malware-shared-on-microsoft-onedrive">https://www.netskope.com/blog/ursnif-data-theft-malware-shared-on-microsoft-onedrive</a></p>
<p><a href="https://www.mbsd.jp/blog/20180607.html">https://www.mbsd.jp/blog/20180607.html</a></p>

  
  </div>
</article>


    

  </div>
</body>

<link rel="stylesheet" href=/lib/font-awesome/css/all.min.css>
<script src=/lib/jquery/jquery.min.js></script>
<script src=/js/main.js></script>
</html>
